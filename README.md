# MinIO Console

![build](https://github.com/minio/console/workflows/Go/badge.svg) ![license](https://img.shields.io/badge/license-AGPL%20V3-blue)

A graphical user interface for [MinIO](https://github.com/minio/minio)

| Object Browser                     | Dashboard                     | Creating a bucket             |
|------------------------------------|-------------------------------|-------------------------------|
| ![Object Browser](images/pic3.png) | ![Dashboard](images/pic1.png) | ![Dashboard](images/pic2.png) |

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**Table of Contents**

- [MinIO Console](#minio-console)
  - [Install](#install)
    - [Build from source](#build-from-source)
  - [Setup](#setup)
    - [1. Create a user `console` using `mc`](#1-create-a-user-console-using-mc)
    - [2. Create a policy for `console` with admin access to all resources (for testing)](#2-create-a-policy-for-console-with-admin-access-to-all-resources-for-testing)
    - [3. Set the policy for the new `console` user](#3-set-the-policy-for-the-new-console-user)
  - [Start Console service:](#start-console-service)
  - [Start Console service with TLS:](#start-console-service-with-tls)
  - [Connect Console to a Minio using TLS and a self-signed certificate](#connect-console-to-a-minio-using-tls-and-a-self-signed-certificate)
- [Contribute to console Project](#contribute-to-console-project)

<!-- markdown-toc end -->

## Install

MinIO Console is a library that provides a management and browser UI overlay originally for Minio server, with
patches for a Ceph site S3 API compatibility.

The standalone binary installation path has been removed.

In case a Console standalone binary is needed, it can be generated by building this package from source as follows:

### Build from source

> You will need a working Go environment. Therefore, please follow [How to install Go](https://golang.org/doc/install).
> Minimum version required is go1.22

```
go install github.com/CESNET/minio-console/cmd/console@latest
```

## Setup

All `console` needs is a Ceph user with certain privileges and the following setup on your Ceph site.

### 0. Create a user `console` using `radosgw-admin` and set necessary capabilities

```
radosgw-admin user create --uid console --display-name "Minio console manager"
radosgw-admin caps add --uid="console" --caps="oidc-provider=*"
```

### 1. Create a role-policy for `S3Access1` role allowing console users to access S3 resources on a Ceph site

> NOTE: this will allow access to all S3 resources (for testing)

```bash
radosgw-admin role-policy put --role-name='S3Access1' --policy-name='console-policyrole' --policy-doc='{ "Statement": [ { "Effect": "Allow", "Action": ["s3:*"], "Resource": "arn:aws:s3:::*", "Sid": "" } ] }'
```

> NOTE: Additionally, you can create policies to limit the privileges for `console` users, for example, if you
> want the user to only have access to dashboard, buckets, notifications and watch page, the policy should look like
> this:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "admin:ServerInfo"
      ],
      "Effect": "Allow",
      "Sid": ""
    },
    {
      "Action": [
        "s3:ListenBucketNotification",
        "s3:PutBucketNotification",
        "s3:GetBucketNotification",
        "s3:ListMultipartUploadParts",
        "s3:ListBucketMultipartUploads",
        "s3:ListBucket",
        "s3:HeadBucket",
        "s3:GetObject",
        "s3:GetBucketLocation",
        "s3:AbortMultipartUpload",
        "s3:CreateBucket",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:DeleteBucket",
        "s3:PutBucketPolicy",
        "s3:DeleteBucketPolicy",
        "s3:GetBucketPolicy"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::*"
      ],
      "Sid": ""
    }
  ]
}
```

### 2. Configure maximum session duration for console users

```bash
radosgw-admin role update --role-name=S3Access1 --max-session-duration=43200
```

### 3. Enable STS APIs on CEPH Rados Gateway

See this [Guide](https://docs.ceph.com/en/quincy/radosgw/STS/#sts-configuration)

```bash
ceph config set client.radosgw.gateway rgw_sts_key "$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16; echo)"
ceph config set client.radosgw.gateway rgw_s3_auth_use_sts true
```

> NOTE: Minio requires this API to be enabled to perform AssumeRole* calls to obtain session tokens

### 4. Configure OIDC federated auth provider on CEPH

First obtain the certificates for your IDP
```bash
# Address of a local Keycloak IDP instance
IDP_URL='http://localhost:8080'

# Get the configuration document from your IDP’s URL, look for link to certs:
curl -k -v \
     -X GET \
     -H "Content-Type: application/x-www-form-urlencoded" \
     "${IDP_URL}/realms/minio/.well-known/openid-configuration" \
   | jq .jwks_uri

# Get the IDP certificate:
curl -k -v \
     -X GET \
     -H "Content-Type: application/x-www-form-urlencoded" \
     "${IDP_URL}/realms/minio/protocol/openid-connect/certs" \  # Here we use the link from jwks_uri
     | jq -rc .keys[].x5c
```

Wrap the x5c certificate content with begin & end tags and save into file:
```
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
```

1. Obtain certificate fingerprint:

```bash
FINGERPRINT=$(openssl x509 -in $CERT_FILE -fingerprint -noout)
# A0BCAA788F28DB6C50C112301DFC71D616C5AAF7F
```
2. Use `console` user credentials with `aws-cli` to register OIDC provider to Ceph Rados Gateway

```bash
aws --profile minio --endpoint-url http://radowgw.example \
  iam create-open-id-connect-provider \
  --url $IDP_URL/realms/ceph \
  --thumbprint-list $FINGERPRINT
```

3. Enable federated users to `AssumeRole` on Ceph STS APIs with their federated OIDC identity

```json
// rolepolicy.json
{
 "Version": "2012-10-17",
 "Statement": [
   {
     "Effect": "Allow",
     "Principal": {
       "Federated": [
         "arn:aws:iam:::oidc-provider/localhost:8080/realms/ceph"
       ]
     },
     "Action": [
       "sts:AssumeRoleWithWebIdentity"
     ],
     "Condition": {
       "StringLike": { "localhost:8080/realms/ceph:aud":"minio-console" }
     }
   }
 ]
}
```
```bash
radosgw-admin role create --role-name oidc-user --assume-role-policy-doc=$(jq -rc . rolepolicy.json)
```
### 5. Configure OIDC provider on MinIO Console

Specify your OIDC provider settings in JSON config:
```json
// openid-configuration.json
{
  "Keycloak": {  // Name of OIDC provider
    "URL": "http://localhost:8080/realms/ceph/.well-known/openid-configuration",
    "DisplayName": "My IdP",
    "ClientID": "minio-console",
    "ClientSecret": "secret-generated-by-idp",
    "HMACSalt": "a2380d25-0891-49cb-b0ac-32d1c3f41e09",
    "HMACPassphrase": "some-secet-pass",
    "Scopes": "openid,profile,email,minio-authorization",
    "Userinfo": false,
    "RedirectCallbackDynamic": true,
    "RedirectCallback": "http://golocalhost:9100/oauth_callback",
    "EndSessionEndpoint": "http://localhost:8080/realms/ceph/protocol/openid-connect/logout",
    "RoleArn": "arn:aws:iam:::role/federated-users"
  }
}
```

Use it in MinIO console ENVironment:

```bash
export CONSOLE_OPENID_CONFIG=$(cat openid-configuration.json | base64)
```

## Start Console service:

Before running console service, following environment settings must be supplied

```sh
# Salt to encrypt JWT payload
export CONSOLE_PBKDF_PASSPHRASE=SECRET

# Required to encrypt JWT payload
export CONSOLE_PBKDF_SALT=SECRET

# MinIO Endpoint
export CONSOLE_MINIO_SERVER=http://localhost:9000
```

Now start the console service.

```
./console server
2021-01-19 02:36:08.893735 I | 2021/01/19 02:36:08 server.go:129: Serving console at http://localhost:9090
```

By default `console` runs on port `9090` this can be changed with `--port` of your choice.

## Start Console service with TLS:

Copy your `public.crt` and `private.key` to `~/.console/certs`, then:

```sh
./console server
2021-01-19 02:36:08.893735 I | 2021/01/19 02:36:08 server.go:129: Serving console at http://[::]:9090
2021-01-19 02:36:08.893735 I | 2021/01/19 02:36:08 server.go:129: Serving console at https://[::]:9443
```

For advanced users, `console` has support for multiple certificates to service clients through multiple domains.

Following tree structure is expected for supporting multiple domains:

```sh
 certs/
  │
  ├─ public.crt
  ├─ private.key
  │
  ├─ example.com/
  │   │
  │   ├─ public.crt
  │   └─ private.key
  └─ foobar.org/
     │
     ├─ public.crt
     └─ private.key
  ...

```

## Connect Console to a Minio using TLS and a self-signed certificate

Copy the MinIO `ca.crt` under `~/.console/certs/CAs`, then:

```sh
export CONSOLE_MINIO_SERVER=https://localhost:9000
./console server
```

You can verify that the apis work by doing the request on `localhost:9090/api/v1/...`

## Debug logging

In some cases it may be convenient to log all HTTP requests. This can be enabled by setting
the `CONSOLE_DEBUG_LOGLEVEL` environment variable to one of the following values:

 - `0` (default) uses no logging.
 - `1` log single line per request for server-side errors (status-code 5xx).
 - `2` log single line per request for client-side and server-side errors (status-code 4xx/5xx).
 - `3` log single line per request for all requests (status-code 4xx/5xx).
 - `4` log details per request for server-side errors (status-code 5xx).
 - `5` log details per request for client-side and server-side errors (status-code 4xx/5xx).
 - `6` log details per request for all requests (status-code 4xx/5xx).

 A single line logging has the following information:
 - Remote endpoint (IP + port) of the request. Note that reverse proxies may hide the actual remote endpoint of the client's browser.
 - HTTP method and URL
 - Status code of the response (websocket connections are hijacked, so no response is shown)
 - Duration of the request

The detailed logging also includes all request and response headers (if any).
 
# Contribute to console Project

Please follow console [Contributor's Guide](https://github.com/minio/console/blob/master/CONTRIBUTING.md)
